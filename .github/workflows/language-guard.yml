# Language Guard - Enforce codebase purity
# Rejects PRs and commits with forbidden languages
# "What can be said at all can be said clearly... in ReScript"

name: Language Guard

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

jobs:
  language-guard:
    name: Enforce Language Policy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for forbidden languages
        id: forbidden-check
        run: |
          echo "ğŸ” Scanning for forbidden languages..."

          FORBIDDEN_FOUND=0
          FORBIDDEN_FILES=""

          # TypeScript (the primary evil)
          TS_FILES=$(find . -type f \( -name "*.ts" -o -name "*.tsx" \) \
            ! -path "./.git/*" ! -path "./node_modules/*" | head -100)
          if [ -n "$TS_FILES" ]; then
            echo "âŒ FORBIDDEN: TypeScript files detected!"
            echo "$TS_FILES"
            FORBIDDEN_FOUND=1
            FORBIDDEN_FILES="$FORBIDDEN_FILES$TS_FILES\n"
          fi

          # CoffeeScript
          COFFEE_FILES=$(find . -type f -name "*.coffee" \
            ! -path "./.git/*" | head -100)
          if [ -n "$COFFEE_FILES" ]; then
            echo "âŒ FORBIDDEN: CoffeeScript files detected!"
            echo "$COFFEE_FILES"
            FORBIDDEN_FOUND=1
            FORBIDDEN_FILES="$FORBIDDEN_FILES$COFFEE_FILES\n"
          fi

          # Go
          GO_FILES=$(find . -type f -name "*.go" \
            ! -path "./.git/*" | head -100)
          if [ -n "$GO_FILES" ]; then
            echo "âŒ FORBIDDEN: Go files detected!"
            echo "$GO_FILES"
            FORBIDDEN_FOUND=1
            FORBIDDEN_FILES="$FORBIDDEN_FILES$GO_FILES\n"
          fi

          # Python (unless Salt)
          PY_FILES=$(find . -type f -name "*.py" \
            ! -path "./.git/*" ! -path "*salt*" ! -path "*Salt*" | head -100)
          if [ -n "$PY_FILES" ]; then
            echo "âŒ FORBIDDEN: Python files detected (non-Salt)!"
            echo "$PY_FILES"
            FORBIDDEN_FOUND=1
            FORBIDDEN_FILES="$FORBIDDEN_FILES$PY_FILES\n"
          fi

          # npm artifacts (node_modules should never be committed)
          if [ -d "node_modules" ]; then
            echo "âŒ FORBIDDEN: node_modules directory detected!"
            FORBIDDEN_FOUND=1
          fi

          # package.json (npm dependency)
          if [ -f "package.json" ]; then
            echo "âŒ FORBIDDEN: package.json detected! Use deno.json instead."
            FORBIDDEN_FOUND=1
          fi

          # package-lock.json
          if [ -f "package-lock.json" ]; then
            echo "âŒ FORBIDDEN: package-lock.json detected!"
            FORBIDDEN_FOUND=1
          fi

          # tsconfig.json
          if [ -f "tsconfig.json" ]; then
            echo "âŒ FORBIDDEN: tsconfig.json detected!"
            FORBIDDEN_FOUND=1
          fi

          if [ $FORBIDDEN_FOUND -eq 1 ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  ğŸš« FORBIDDEN LANGUAGES DETECTED - BUILD WILL FAIL"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "This project ONLY accepts:"
            echo "  âœ… ReScript (.res, .resi)"
            echo "  âœ… SCSS (.scss)"
            echo "  âœ… Shell scripts (.sh)"
            echo "  âœ… Scheme/Lisp (.scm)"
            echo "  âœ… Deno configuration (deno.json)"
            echo "  âœ… Rust (.rs) - for WASM modules"
            echo "  âœ… Lean 4 (.lean) - for formal verification"
            echo "  âœ… Julia (.jl) - for noise analysis (v2.0)"
            echo "  âœ… Python (.py) - ONLY if Salt-related"
            echo ""
            echo "BANNED:"
            echo "  âŒ TypeScript (.ts, .tsx)"
            echo "  âŒ CoffeeScript (.coffee)"
            echo "  âŒ Go (.go)"
            echo "  âŒ npm (package.json, node_modules)"
            echo "  âŒ Any other 'evilscripts'"
            echo ""
            exit 1
          fi

          echo "âœ… Language policy check passed!"

      - name: Verify ReScript files exist
        run: |
          echo "ğŸ” Checking for ReScript source files..."

          RES_COUNT=$(find . -type f -name "*.res" ! -path "./.git/*" | wc -l)

          if [ "$RES_COUNT" -eq 0 ]; then
            echo "âš ï¸ Warning: No ReScript files found. Is this a new project?"
          else
            echo "âœ… Found $RES_COUNT ReScript file(s)"
            find . -type f -name "*.res" ! -path "./.git/*"
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“‹ LANGUAGE GUARD SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Accepted languages: ReScript, SCSS, Shell, Scheme, Rust, Lean, Julia"
          echo "Banned languages: TypeScript, CoffeeScript, Go, Python (non-Salt), npm"
          echo ""
          echo "\"What can be said at all can be said clearly... in ReScript\""
          echo ""
